<!DOCTYPE html>
<html>

<head>
    <title>Lojas Continente</title>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Continente">
    <style type="text/css">
        html,
        body {
            background: #EEEEEE;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: "Trebuchet MS", Helvetica, sans-serif
        }
        
        h3 {
            color: #D6081A;
            margin: 0 0 15px
        }
        
        p {
            color: #777;
            margin: 0
        }
        
        #mapholder {
            width: 100%;
            height: 100%
        }
        
        .sep {
            display: block;
            width: 100%;
            height: 1px;
            margin: 8px auto 8px auto;
            border-top: 1px solid #DDD
        }
    </style>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&amp;language=pt-PT&amp;libraries=geometry"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
        var map;
        var infoWindow;
        var gmarkers = [];

        function getClosestStore(pos) {
            var currentPos = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            var closestMarker = -1;
            var closestDistance = Number.MAX_VALUE;
            var i = gmarkers.length;
            var distance;

            map.setZoom(13);

            while (i) {
                i -= 1;
                distance = google.maps.geometry.spherical.computeDistanceBetween(gmarkers[i].getPosition(), currentPos);
                if (distance < closestDistance) {
                    closestMarker = i;
                    closestDistance = distance;
                }
            }
            infoWindow.setContent(gmarkers[closestMarker].html);
            infoWindow.open(map, gmarkers[closestMarker]);
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getClosestStore, showError);
            }
        }

        /*function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(zoomPosition, showError);
            }
        }

        function zoomPosition(position) {
            map.panTo(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
            map.setZoom(13);
        }*/

        function showMap(store) {
            var latlng = new google.maps.LatLng(39.900000, -15.110685);
            var mapOptions = {
                zoom: 5,
                center: latlng,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.TOP_RIGHT
                },
                streetViewControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER
                },
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            map = new google.maps.Map(document.getElementById("mapholder"), mapOptions);

            var customMarker = {
                url: "../Imagens/marker_continente.png",
                size: new google.maps.Size(25, 40),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(0, 40)
            };

            infoWindow = new google.maps.InfoWindow({
                content: "<b>A carregar</b>...<hr>",
                //disableAutoPan: true,
                maxWidth: 250
            });


            for (s = 0; s < store.length; s++) {
                var latlng = new google.maps.LatLng(store[s][0], store[s][1]);
                var contacts = "";
                if (store[s][6] && store[s][6] != "" && store[s][6] != " ") {
                    contacts = "<span class='sep'></span><p><b>Hor√°rio:</b> " + store[s][6] + "</p>";
                }
                if (store[s][4] && store[s][4] != "" && store[s][4] != " ") {
                    contacts += "<span class='sep'></span><p><b>Telefone:</b> " + store[s][4] + "</p>";
                }
                if (store[s][5] && store[s][5] != "" && store[s][5] != " ") {
                    contacts += "<p><b>Fax:</b> " + store[s][5] + "</p>";
                }
                var marker = new google.maps.Marker({
                    position: latlng,
                    title: store[s][2],
                    map: map,
                    icon: customMarker,
                    zIndex: s,
                    html: "<div id='map_content'><h3>" + store[s][2] + "</h3><p><b>Morada: </b>" + store[s][3] + "</p>" + contacts + "</div>"
                });
                google.maps.event.addListener(marker, "click", function() {
                    infoWindow.setContent(this.html);
                    infoWindow.open(map, this);
                    //map.setCenter(this.getPosition());
                });
                gmarkers.push(marker);
            }
            getLocation();
        }

        function showError(error) {
            if (console.log) {
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        console.log("User denied the request for Geolocation.");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        console.log("Location information is unavailable.");
                        break;
                    case error.TIMEOUT:
                        console.log("The request to get user location timed out.");
                        break;
                    case error.UNKNOWN_ERROR:
                        console.log("An unknown error occurred.");
                        break;
                }
            }
        }

        function loadStores(url, fn) {
            var request = new XMLHttpRequest;
            request.addEventListener("load", fn);
            request.open("GET", url, true);
            request.send();
        }

        function setupStores(json) {
            var stores = JSON.parse(json.target.response).GetRetailStoresResult.Result;
            store = new Array();
            for (var i in stores) {
                array_push = [
                    stores[i].Latitude,
                    stores[i].Longitude,
                    "Continente Modelo - " + stores[i].Name.split(" -")[0],
                    stores[i].Address,
                    stores[i].Telephone,
                    stores[i].Fax,
                    stores[i].OpeningAndClosingHourDescription
                ];
                store.push(array_push);
            }

            showMap(store);
        }
    </script>
</head>

<body>
    <div id="mapholder"></div>
    <script type="text/javascript">
        loadStores("http://m.folhetos.continente.pt/scripts/get_stores.php", setupStores);
    </script>
</body>

</html>